<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾å€é€šå ±æŸ¥è©¢ç³»çµ±</title>
    <!-- å¼•å…¥ Bootstrap 5 (RWD éŸ¿æ‡‰å¼è¨­è¨ˆ) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* èª¿æ•´ body å…§é‚Šè·ï¼Œåœ¨å°è¢å¹•ä¸Šæ¸›å°‘å·¦å³ç©ºé–“ä½”ç”¨ */
        body { background-color: #e9ecef; padding: 20px 10px; font-family: 'Inter', sans-serif; }
        .search-container { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            margin-bottom: 25px; 
        }
        .table-responsive {
            border-radius: 12px;
            overflow: hidden; /* ç¢ºä¿åœ“è§’æ•ˆæœ */
        }
        .table thead th {
            font-weight: 700;
            /* å…è¨±æ¨™é¡Œæ›è¡Œä»¥é©æ‡‰æ‰‹æ©Ÿç•«é¢ */
        }
        /* è™•ç†ç‹€æ…‹çš„è¦–è¦ºåŒ– */
        .status-done { 
            color: white; 
            font-weight: bold; 
            background-color: #28a745; /* Green - å·²å®Œæˆ */
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            white-space: nowrap; /* ç¢ºä¿ç‹€æ…‹æ–‡å­—ä¸è¢«æˆªæ–· */
            font-size: 0.85rem;
        }
        .status-wait { 
            color: white; 
            font-weight: bold; 
            background-color: #dc3545; /* Red - æœªå®Œæˆ */
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            white-space: nowrap; /* ç¢ºä¿ç‹€æ…‹æ–‡å­—ä¸è¢«æˆªæ–· */
            font-size: 0.85rem;
        }

        /* RWD å„ªåŒ–ï¼šéš±è—æ‰‹æ©Ÿç•«é¢ä¸Šä¸é‡è¦çš„è¡¨æ ¼æ¬„ä½ */
        @media (max-width: 768px) {
            /* éš±è—æ™‚é–“æˆ³è¨˜æ¬„ä½ */
            .hide-on-mobile {
                display: none;
            }
            /* è®“ container åœ¨å°è¢å¹•ä¸Šæœ€å¤§åŒ–åˆ©ç”¨ç©ºé–“ï¼Œç§»é™¤å…©å´é è¨­å¡«å…… */
            .container {
                padding-left: 5px !important; /* å¼·åˆ¶è¦†è“‹ Bootstrap é è¨­å¡«å…… */
                padding-right: 5px !important;
                max-width: 100%; /* ç¢ºä¿å®¹å™¨å¯ä»¥å®Œå…¨ä¼¸å±• */
            }
            /* è®“è¡¨æ ¼å…§çš„æ–‡å­—åœ¨æ‰‹æ©Ÿä¸Šå¯ä»¥è‡ªå‹•æ›è¡Œ */
            .table td, .table th {
                white-space: normal;
                word-break: break-word;
            }
        }
    </style>
</head>
<body>

<!-- RWD å„ªåŒ–ï¼šåœ¨å°è¢å¹•ä¸Šä½¿ç”¨ container-fluid ä»¥ç²å¾—æ›´å¤šå¯¬åº¦ -->
<div class="container my-5">
    <h1 class="text-center mb-5 text-primary">ğŸ˜ï¸ ç¤¾å€é€šå ±è³‡æ–™æŸ¥è©¢ä¸­å¿ƒ</h1>

    <!-- æŸ¥è©¢éæ¿¾å€å¡Š -->
    <div class="search-container">
        <h5 class="mb-3">è³‡æ–™ç¯©é¸</h5>
        <div class="row g-3">
            <!-- æœå°‹é‡Œåˆ¥ (å·²æ”¹ç‚ºä¸‹æ‹‰é¸å–®) -->
            <div class="col-md-5 col-lg-4">
                <label for="filterVillage" class="form-label fw-bold">ä¾é‡Œåˆ¥ç¯©é¸</label>
                <select id="filterVillage" class="form-select">
                    <option value="">é¸æ“‡å…¨éƒ¨é‡Œåˆ¥</option>
                    <!-- é¸é …å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                </select>
            </div>
            <!-- è™•ç†ç‹€æ…‹ -->
            <div class="col-md-5 col-lg-4">
                <label for="filterStatus" class="form-label fw-bold">è™•ç†ç‹€æ…‹</label>
                <select id="filterStatus" class="form-select" onchange="displayData()">
                    <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="V">å·²å®Œæˆ (V)</option>
                    <option value="X">æœªå®Œæˆ (X)</option>
                </select>
            </div>
            <!-- ç¯©é¸æŒ‰éˆ• (ç¾åœ¨ä¸»è¦ç”¨æ–¼ç‹€æ…‹ç¯©é¸ï¼Œé‡Œåˆ¥æœƒè‡ªå‹•è§¸ç™¼) -->
            <div class="col-md-2 col-lg-4 d-flex align-items-end">
                <button class="btn btn-primary w-100 py-2" onclick="displayData()">ç«‹å³ç¯©é¸</button>
            </div>
        </div>
    </div>

    <!-- è³‡æ–™è¡¨æ ¼é¡¯ç¤ºå€ -->
    <div class="table-responsive">
        <table class="table table-striped bg-white shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th scope="col" class="hide-on-mobile">æ™‚é–“æˆ³è¨˜</th> <!-- æ‰‹æ©Ÿéš±è— -->
                    <th scope="col">ç¤¾å€é‡Œåˆ¥</th>
                    <th scope="col" class="hide-on-mobile">é„°é•·ç·¨è™Ÿ</th> <!-- æ‰‹æ©Ÿéš±è— -->
                    <th scope="col">é€šå ±é¡åˆ¥</th>
                    <th scope="col">æ‚¨æƒ³æ”¹å–„å•é¡Œé¸é …</th> 
                    <th scope="col">è™•ç†ç‹€æ…‹</th>
                </tr>
            </thead>
            <tbody id="dataBody">
                <!-- è³‡æ–™è¼‰å…¥ä¸­çš„é è¨­è¨Šæ¯ï¼Œæ¬„ä½æ•¸å¢åŠ åˆ° 6 -->
                <tr><td colspan="6" class="text-center py-4 text-muted">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // *******************************************************************
    // ã€å·²æ›´æ–°ç‚ºæ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€ã€‘
    // *******************************************************************
    const API_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiIb-0nsspLls_O2Ip_C7D5RVX_JRsjqmz3CHOwMonmuYu8UEZKULA0GNi6_xNWaZQzjlwRGaz1cba4dflWmG_heNLp6ztXWzyaQHhxaauiim117DbbYaBZGR7t1L4guPmYTzbgjVUW-CLd5D9SQj0wJRVLixNfFsny5Q8Zgu0x7Y6GpuZ0m_jEk-enk9wRVwitCPOPJ1uLxHtm0eRVJ9Z7egK2ByTse49Lt5I8wSbAHxKs53erl30VBZWozj36x4mUYoUtj3gTKKXZalTKs1riUhEGyA&lib=MRODCX4RmlI851JcMLCsDUWRRykl-Pzzp'; 

    let allData = []; // ç”¨ä¾†å„²å­˜å¾ API æŠ“å–çš„æ‰€æœ‰è³‡æ–™
    
    // ç§»é™¤äº†æ¨¡æ“¬æ•¸æ“š (MOCK_DATA) å€å¡Šï¼Œç›´æ¥ä½¿ç”¨ API æŠ“å–

    /**
     * è¼”åŠ©å‡½æ•¸ï¼šå˜—è©¦å¾æ•¸æ“šé …ä¸­ç²å–æ­£ç¢ºçš„è™•ç†ç‹€æ…‹éµå
     * @param {Object} item - å–®ç­†è³‡æ–™ç‰©ä»¶
     * @returns {string|null} - è™•ç†ç‹€æ…‹çš„éµå
     */
    function getStatusKey(item) {
        // 1. å˜—è©¦å¸¸è¦‹ç°¡ç¨± (è™•ç†ç‹€æ…‹)
        if (item.hasOwnProperty("è™•ç†ç‹€æ…‹")) {
            return "è™•ç†ç‹€æ…‹";
        }
        // 2. å˜—è©¦è¡¨å–®é è¨­åç¨± (æ˜¯å¦è™•ç†å®Œæˆ) - æ­£ç¢ºçš„ã€Œè™•ç†ã€
        if (item.hasOwnProperty("æ˜¯å¦è™•ç†å®Œæˆ")) {
            return "æ˜¯å¦è™•ç†å®Œæˆ";
        }
        // 3. å˜—è©¦ç”¨æˆ¶æä¾›å¸¶æœ‰éŒ¯åˆ¥å­—çš„åç¨± (æ˜¯å¦è™•è£¡å®Œæˆ) - å¸¶éŒ¯å­—ã€Œè™•è£¡ã€
        if (item.hasOwnProperty("æ˜¯å¦è™•è£¡å®Œæˆ")) {
            return "æ˜¯å¦è™•è£¡å®Œæˆ";
        }
        return null;
    }

    /**
     * å‹•æ…‹å¡«å……é‡Œåˆ¥ç¯©é¸ä¸‹æ‹‰é¸å–®
     */
    function populateVillageFilter() {
        const select = document.getElementById('filterVillage');
        const villages = new Set();

        allData.forEach(item => {
            const village = item["ç¤¾å€é‡Œåˆ¥"];
            if (village && String(village).trim() !== '') {
                villages.add(village);
            }
        });

        // æ¸…ç©ºèˆŠé¸é … (é™¤äº†ç¬¬ä¸€å€‹ "é¸æ“‡å…¨éƒ¨é‡Œåˆ¥")
        while (select.options.length > 1) {
            select.remove(1);
        }

        // å°‡é‡Œåˆ¥åç¨±è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº (ä½¿ç”¨ä¸­æ–‡æ’åº)
        const sortedVillages = Array.from(villages).sort((a, b) => a.localeCompare(b, 'zh-TW'));

        sortedVillages.forEach(village => {
            const option = document.createElement('option');
            option.value = village;
            option.textContent = village;
            select.appendChild(option);
        });

        // è¨­ç½®é‡Œåˆ¥ä¸‹æ‹‰é¸å–®çš„è®Šå‹•äº‹ä»¶ï¼Œè®“å…¶åœ¨é¸æ“‡å¾Œè‡ªå‹•è§¸ç™¼ç¯©é¸
        select.addEventListener('change', displayData);
    }

    // 1. å¾ GAS API æŠ“å–è³‡æ–™
    async function fetchData() {
        try {
            // ä½¿ç”¨ fetch æŠ“å–è³‡æ–™
            const response = await fetch(API_URL);
            if (!response.ok) {
                // æ¬„ä½æ•¸ä½¿ç”¨æ¡Œé¢ç‰ˆ colspan=6
                const statusText = response.status === 404 
                    ? `è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ŒHTTP éŒ¯èª¤ç¢¼: ${response.status} (ç¶²å€å¯èƒ½å·²å¤±æ•ˆæˆ–éƒ¨ç½²æ¬Šé™æœ‰èª¤)`
                    : `è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ŒHTTP éŒ¯èª¤ç¢¼: ${response.status}`;
                
                document.getElementById('dataBody').innerHTML = `<tr><td colspan="6" class="text-danger text-center py-4">
                    ${statusText}
                </td></tr>`;
                
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            // é€™è£¡å‡è¨­çœŸå¯¦ GAS API è¿”å›çš„ JSON æ ¼å¼
            allData = await response.json(); 
            console.log("è³‡æ–™å·²æˆåŠŸè¼‰å…¥:", allData);
            
            // è¼‰å…¥è³‡æ–™å¾Œï¼Œå¡«å……é‡Œåˆ¥ç¯©é¸å™¨
            populateVillageFilter(); 
            
            displayData(); // æˆåŠŸè¼‰å…¥å¾Œï¼Œç«‹å³é¡¯ç¤ºè³‡æ–™
        } catch (error) {
            // è™•ç†é HTTP éŒ¯èª¤ (ä¾‹å¦‚ç¶²è·¯é€£ç·šéŒ¯èª¤)
            console.error("è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            // ç¢ºä¿éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºåœ¨è¡¨æ ¼ä¸­
            if (!document.getElementById('dataBody').innerHTML.includes('è¼‰å…¥å¤±æ•—')) {
                document.getElementById('dataBody').innerHTML = `<tr><td colspan="6" class="text-danger text-center py-4">
                    è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå¯èƒ½åŸå› ï¼šç¶²è·¯é€£ç·šå•é¡Œæˆ– GAS éƒ¨ç½²æ¬Šé™å•é¡Œã€‚
                </td></tr>`;
            }
        }
    }

    // 2. ç¯©é¸ä¸¦é¡¯ç¤ºè³‡æ–™
    function displayData() {
        const villageFilter = document.getElementById('filterVillage').value.trim(); // å–å¾—é¸ä¸­çš„é‡Œåˆ¥å€¼ (å¯èƒ½æ˜¯ç©ºå­—ä¸²æˆ–å¯¦éš›é‡Œå)
        const statusFilter = document.getElementById('filterStatus').value; // é€™è£¡æ‹¿åˆ° V, X, æˆ–ç©ºå­—ä¸²
        const tbody = document.getElementById('dataBody');
        
        tbody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å…§å®¹

        // æ ¹æ“šä½¿ç”¨è€…è¼¸å…¥é€²è¡Œç¯©é¸
        const filtered = allData.filter(item => {
            // è™•ç†ç‹€æ…‹çš„éµåæŸ¥æ‰¾
            const statusKey = getStatusKey(item);
            
            // é‡Œåˆ¥ç¯©é¸ï¼šä¸‹æ‹‰é¸å–®é¸ä¸­ç©ºå­—ä¸²æ™‚ï¼Œä¸éæ¿¾ï¼›å¦å‰‡åŸ·è¡Œç²¾ç¢ºåŒ¹é…
            const villageValue = String(item["ç¤¾å€é‡Œåˆ¥"] || '');
            const villageMatch = !villageFilter || villageValue === villageFilter; // ç²¾ç¢ºåŒ¹é…

            // ç‹€æ…‹ç¯©é¸ï¼šæª¢æŸ¥åŸå§‹æ•¸æ“š (V, X) æ˜¯å¦èˆ‡ç¯©é¸å™¨çš„å€¼åŒ¹é…
            const currentRawStatus = statusKey ? (item[statusKey] || '').toUpperCase() : ''; // ç²å– V æˆ– X
            const statusMatch = statusFilter === "" || (currentRawStatus === statusFilter); // æª¢æŸ¥ V/X åŒ¹é…
            
            return villageMatch && statusMatch;
        });

        // åˆ¤æ–·ç•¶å‰æ˜¯å¦åœ¨è¡Œå‹•è£ç½®ä¸Šï¼ˆæ ¹æ“š CSS å®šç¾©çš„æ–·é» 768pxï¼‰
        const isMobile = window.matchMedia("(max-width: 768px)").matches;
        
        // ç”±æ–¼æˆ‘å€‘åœ¨æ‰‹æ©Ÿä¸Šéš±è—äº†å…©å€‹æ¬„ä½ï¼Œæ‰€ä»¥ç¸½ colspan éœ€è¦èª¿æ•´
        const colspanCount = isMobile ? 4 : 6; 

        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${colspanCount}" class="text-center py-4 text-info">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„ç›¸é—œè³‡æ–™</td></tr>`;
            return;
        }

        // å»ºç«‹è¡¨æ ¼åˆ— (Row)
        filtered.forEach(item => {
            // è™•ç†ç‹€æ…‹é¡¯ç¤ºé‚è¼¯
            const statusKey = getStatusKey(item);
            const rawStatus = statusKey ? (item[statusKey] || '').toUpperCase() : '';

            let statusText;
            let statusClass;

            if (rawStatus === 'V') {
                statusText = 'å·²å®Œæˆ (V)';
                statusClass = 'status-done';
            } else if (rawStatus === 'X') {
                statusText = 'æœªå®Œæˆ (X)';
                statusClass = 'status-wait';
            } else {
                statusText = rawStatus || 'æœªçŸ¥';
                statusClass = 'text-muted'; 
            }
            
            // ç¢ºä¿æ™‚é–“æˆ³è¨˜é¡¯ç¤ºç‚ºå¯è®€æ ¼å¼
            const timestamp = new Date(item["æ™‚é–“æˆ³è¨˜"]).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
            
            // ç²å–ã€Œé€šå ±é¡åˆ¥ã€ (å·²åŒ…å«å¤šéµåå®¹éŒ¯)
            let reportCategory = item["é€šå ±é¡åˆ¥"];
            if (!reportCategory || reportCategory === '-') {
                // å˜—è©¦å¸¸è¦‹çš„æ›¿ä»£éµåï¼šå•é¡Œé¡åˆ¥ã€é€šå ±äº‹é …ã€å•é¡Œé¡å‹
                reportCategory = item["å•é¡Œé¡åˆ¥"] || item["é€šå ±äº‹é …"] || item["å•é¡Œé¡å‹"] || '-';
            }
            reportCategory = reportCategory || '-';

            // ç²å–ã€Œé„°é•·ç·¨è™Ÿã€ (å·²åŒ…å«å¤šéµåå®¹éŒ¯)
            let neighborChief = item["æ‚¨æ˜¯ç¬¬å¹¾é„°é•·"];
            if (!neighborChief || neighborChief === '-') {
                 // å˜—è©¦å¸¸è¦‹çš„æ›¿ä»£éµåï¼šé„°é•·ç·¨è™Ÿ
                neighborChief = item["é„°é•·ç·¨è™Ÿ"] || item["é„°é•·"] || '-';
            }
            neighborChief = neighborChief || '-';


            // å–å¾—ã€Œæ‚¨æƒ³æ”¹å–„å•é¡Œé¸é …ã€çš„æ¬„ä½è³‡æ–™
            const problemOption = item["æ‚¨æƒ³æ”¹å–„å•é¡Œé¸é …"] || '-'; 

            const row = `<tr>
                <td class="hide-on-mobile">${timestamp}</td> <!-- æ‰‹æ©Ÿéš±è— -->
                <td>${item["ç¤¾å€é‡Œåˆ¥"] || '-'}</td>
                <td class="hide-on-mobile">${neighborChief}</td> <!-- æ‰‹æ©Ÿéš±è— -->
                <td>${reportCategory}</td> 
                <td>${problemOption}</td> 
                <td><span class="${statusClass}">${statusText}</span></td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // ç¶²é å•Ÿå‹•æ™‚ï¼Œè¼‰å…¥è³‡æ–™
    fetchData();
    
    // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼Œå¦‚æœè¡¨æ ¼æ¬„ä½æ•¸å›  RWD è€Œæ”¹è®Šï¼Œéœ€è¦èª¿æ•´ colspan çš„å€¼
    window.addEventListener('resize', () => {
        // åœ¨ resize æ™‚ï¼Œé‡æ–°åŸ·è¡Œ displayData å°±å¯ä»¥ç¢ºä¿ colspan æ­£ç¢º
        displayData();
    });
</script>

</body>
</html>